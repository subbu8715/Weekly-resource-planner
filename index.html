<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resource Availability Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .status-cell { min-width: 100px; height: 70px; transition: transform .2s; }
    .status-cell:hover { transform: scale(1.03); cursor:pointer; }
    .status-wfo { background-color:#166534; color:#fff; }
    .status-wfh { background-color:#86efac; color:#14532d; }
    .status-planned-leave { background-color:#f97316; color:#fff; }
    .status-unplanned-leave { background-color:#b91c1c; color:#fff; }
    .status-default { background-color:#f3f4f6; }
    .modal-backdrop { background: rgba(0,0,0,.5); }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <header class="text-center mb-6">
      <h1 class="text-4xl font-bold text-gray-900">Resource Availability Tracker</h1>
      <p id="week-range" class="text-xl text-gray-600 mt-2"></p>
    </header>

    <!-- Controls -->
    <div class="flex flex-wrap items-center justify-center gap-3 mb-6">
      <button id="prev-week" class="bg-white px-4 py-2 rounded-lg shadow font-semibold hover:bg-gray-200">- Week</button>
      <button id="today" class="bg-white px-4 py-2 rounded-lg shadow font-semibold hover:bg-gray-200">Today</button>
      <button id="next-week" class="bg-white px-4 py-2 rounded-lg shadow font-semibold hover:bg-gray-200">+ Week</button>
      <button id="team-bulk-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow font-semibold hover:bg-blue-700">Team Bulk Update (Mon–Fri)</button>
    </div>

    <!-- Grid -->
    <div class="bg-white rounded-xl shadow-lg p-4 overflow-hidden">
      <table class="w-full border-collapse">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- Legend -->
    <div class="mt-6">
      <h2 class="text-lg font-semibold mb-2">Legend</h2>
      <div class="flex flex-wrap gap-3">
        <span class="px-3 py-2 rounded-lg status-wfo font-semibold">WFO</span>
        <span class="px-3 py-2 rounded-lg status-wfh font-semibold">WFH</span>
        <span class="px-3 py-2 rounded-lg status-planned-leave font-semibold">Planned Leave</span>
        <span class="px-3 py-2 rounded-lg status-unplanned-leave font-semibold">Unplanned Leave</span>
        <span class="px-3 py-2 rounded-lg status-default font-semibold">No Data</span>
      </div>
    </div>
  </div>

  <!-- Status Modal -->
  <div id="status-modal" class="modal-backdrop fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
      <h2 class="text-2xl font-bold mb-1">Set Status</h2>
      <p id="status-info" class="text-gray-600 mb-4"></p>
      <div class="grid grid-cols-1 gap-2 mb-2">
        <button class="status-choice status-wfo py-2 rounded font-bold" data-status="wfo">Work from Office</button>
        <button class="status-choice status-wfh py-2 rounded font-bold" data-status="wfh">Work from Home</button>
        <button class="status-choice status-planned-leave py-2 rounded font-bold" data-status="planned-leave">Planned Leave</button>
        <button class="status-choice status-unplanned-leave py-2 rounded font-bold" data-status="unplanned-leave">Unplanned Leave</button>
      </div>
      <input type="text" id="status-comment" class="border mt-2 w-full p-2 rounded" placeholder="Comment (optional)"/>
      <div class="text-right mt-4">
        <button id="clear-status" class="text-red-600 font-semibold mr-2">Clear</button>
        <button id="close-status" class="bg-gray-200 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300 mr-2">Cancel</button>
        <button id="save-status" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700">Save</button>
      </div>
    </div>
  </div>

  <!-- Team Bulk Modal -->
  <div id="team-bulk-modal" class="modal-backdrop fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
      <h2 class="text-2xl font-bold mb-1">Team Bulk Update (Mon–Fri)</h2>
      <p class="text-gray-600 mb-4">Set the same status for all team members this week (Mon–Fri).</p>
      <div class="grid grid-cols-1 gap-2 mb-2">
        <button class="team-bulk-choice status-wfo py-2 rounded font-bold" data-status="wfo">WFO</button>
        <button class="team-bulk-choice status-wfh py-2 rounded font-bold" data-status="wfh">WFH</button>
        <button class="team-bulk-choice status-planned-leave py-2 rounded font-bold" data-status="planned-leave">Planned Leave</button>
        <button class="team-bulk-choice status-unplanned-leave py-2 rounded font-bold" data-status="unplanned-leave">Unplanned Leave</button>
      </div>
      <div class="text-right">
        <button id="close-team-bulk" class="bg-gray-200 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300">Close</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbyKziIiPKCEG8bjnEvYw2oFh0FehfLUCJcB6JKCqIypA-KwNsKCb2qnfAF7hbPKjjah/exec";

    let members = [];
    let statuses = {};
    let currentDate = new Date();
    let selectedCell = null;

    const toISO = d => d.toISOString().split('T')[0];
    const getWeek = (date) => {
      const monday = new Date(date);
      const diff = monday.getDay() === 0 ? -6 : 1 - monday.getDay();
      monday.setDate(monday.getDate() + diff);
      return Array.from({length:7},(_,i)=>{
        const d = new Date(monday);
        d.setDate(monday.getDate()+i);
        return d;
      });
    };

    async function apiGetData(){
      const res = await fetch(API_BASE+"?action=getData&ts="+Date.now());
      return res.json();
    }

    async function apiSetStatus(name,date,status,comment){
      await fetch(API_BASE,{
        method:"POST",
        body: JSON.stringify({action:"setStatus", member:name, date:date, status:status, comment:comment})
      });
    }

    function render(){
      const week = getWeek(currentDate);
      document.getElementById('week-range').textContent = 
        `${week[0].toLocaleDateString('en-US',{month:'short',day:'numeric'})} - ${week[6].toLocaleDateString('en-US',{month:'short',day:'numeric'})}`;
      
      const thead=document.getElementById('thead'), tbody=document.getElementById('tbody');
      thead.innerHTML=""; tbody.innerHTML="";
      const tr=document.createElement('tr');
      tr.innerHTML=`<th class="p-2">Team Member</th>`+
        week.map(d=>`<th class="p-2 text-center">${d.toLocaleDateString('en-US',{weekday:'short'})}<br>${d.getDate()}</th>`).join('');
      thead.appendChild(tr);

      members.forEach(m=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td class="p-2 font-semibold">${m.name}<br><span class="text-sm text-gray-500">${m.role}</span><br><span class="text-xs">Shift: ${m.shift}</span><br><span class="text-xs">Region: ${m.region}</span></td>`;
        week.forEach(d=>{
          const ds=toISO(d), key=`${m.name}_${ds}`, st=statuses[key]?.status;
          const klass=st?`status-${st}`:'status-default';
          tr.innerHTML+=`<td class="p-1 text-center"><div class="status-cell rounded-lg flex items-center justify-center ${klass}" data-name="${m.name}" data-date="${ds}">${st?st.toUpperCase().replace('-',' '):''}</div></td>`;
        });
        tbody.appendChild(tr);
      });
    }

    // Navigation
    document.getElementById('prev-week').onclick=()=>{currentDate.setDate(currentDate.getDate()-7);render();};
    document.getElementById('next-week').onclick=()=>{currentDate.setDate(currentDate.getDate()+7);render();};
    document.getElementById('today').onclick=()=>{currentDate=new Date();render();};

    // Cell click
    document.getElementById('tbody').onclick=(e)=>{
      const cell=e.target.closest('.status-cell');
      if(!cell) return;
      selectedCell={name:cell.dataset.name,date:cell.dataset.date};
      document.getElementById('status-info').textContent=`${cell.dataset.name} on ${cell.dataset.date}`;
      document.getElementById('status-comment').value=statuses[`${cell.dataset.name}_${cell.dataset.date}`]?.comment||'';
      document.getElementById('status-modal').classList.remove('hidden');document.getElementById('status-modal').classList.add('flex');
    };

    // Save status
    document.querySelectorAll('.status-choice').forEach(btn=>{
      btn.onclick=async()=>{
        await apiSetStatus(selectedCell.name,selectedCell.date,btn.dataset.status,document.getElementById('status-comment').value);
        const data=await apiGetData();members=data.members;statuses=data.statuses;render();
        document.getElementById('status-modal').classList.add('hidden');document.getElementById('status-modal').classList.remove('flex');
      };
    });
    document.getElementById('save-status').onclick=async()=>{
      await apiSetStatus(selectedCell.name,selectedCell.date,statuses[`${selectedCell.name}_${selectedCell.date}`]?.status||'',document.getElementById('status-comment').value);
      const data=await apiGetData();members=data.members;statuses=data.statuses;render();
      document.getElementById('status-modal').classList.add('hidden');document.getElementById('status-modal').classList.remove('flex');
    };
    document.getElementById('clear-status').onclick=async()=>{
      await apiSetStatus(selectedCell.name,selectedCell.date,'','');
      const data=await apiGetData();members=data.members;statuses=data.statuses;render();
      document.getElementById('status-modal').classList.add('hidden');document.getElementById('status-modal').classList.remove('flex');
    };
    document.getElementById('close-status').onclick=()=>{document.getElementById('status-modal').classList.add('hidden');document.getElementById('status-modal').classList.remove('flex');};

    // Team bulk modal
    document.getElementById('team-bulk-btn').onclick=()=>{document.getElementById('team-bulk-modal').classList.remove('hidden');document.getElementById('team-bulk-modal').classList.add('flex');};
    document.getElementById('close-team-bulk').onclick=()=>{document.getElementById('team-bulk-modal').classList.add('hidden');document.getElementById('team-bulk-modal').classList.remove('flex');};
    document.querySelectorAll('.team-bulk-choice').forEach(btn=>{
      btn.onclick=async()=>{
        const week=getWeek(currentDate);
        for(const m of members){
          for(const d of week){
            if(d.getDay()>=1&&d.getDay()<=5){
              await apiSetStatus(m.name,toISO(d),btn.dataset.status,'');
            }
          }
        }
        const data=await apiGetData();members=data.members;statuses=data.statuses;render();
        document.getElementById('team-bulk-modal').classList.add('hidden');document.getElementById('team-bulk-modal').classList.remove('flex');
      };
    });

    (async()=>{
      const data=await apiGetData();
      members=data.members||[];statuses=data.statuses||{};render();
    })();
  </script>
</body>
</html>
